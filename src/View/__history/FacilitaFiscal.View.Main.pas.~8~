unit FacilitaFiscal.View.Main;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ComCtrls, Vcl.WinXCtrls,
  Vcl.ExtCtrls, ACBrNFeDANFEFR, ACBrDFe, ACBrNFe, FaciliaDanfe.Controller.Dados,
  Vcl.StdCtrls;

type
  TfrmMain = class(TForm)
    pnCenter: TPanel;
    pnTop: TPanel;
    pnMain: TPanel;
    SplitView1: TSplitView;
    Panel2: TPanel;
    Panel3: TPanel;
    Panel4: TPanel;
    PageControl1: TPageControl;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    TabSheet3: TTabSheet;
    Panel1: TPanel;
    Panel5: TPanel;
    rbRetrato: TRadioButton;
    rbPaisagem: TRadioButton;
    Panel6: TPanel;
    procedure Panel5Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure Panel6Click(Sender: TObject);
  private
    { Private declarations }
    NFe: TACBrNFe;
    DANFe: TACBrNFeDANFEFR;
    iNumeroNFe : integer;
    ValorTotal : Double;
    DataEmissao: TDate;
    sSerieNFe,
    sChaveAcesso,
    sEmitente,
    sDestinatario,
    sCNPJ,
    sArquivoXML: String;
    procedure importaXML(aFileName: string);
    procedure carregaConfiguracoes;
  public
    { Public declarations }
  end;


var
  frmMain: TfrmMain;

implementation

uses
  pcnConversao;

{$R *.dfm}

procedure TfrmMain.carregaConfiguracoes;
begin
  NFE.DANFE := DANFE;
  NFe.NotasFiscais.Clear;
  NFe.Configuracoes.WebServices.Ambiente := taProducao ;
  DANFE.Site := 'fmsoftware.online';
  DANFE.Sistema := 'Facilita Fiscal v1.0';
  DANFE.PathPDF := 'C:\Projetos';
end;

procedure TfrmMain.FormCreate(Sender: TObject);
begin
  try
    NFe := TACBrNFe.Create(nil);
    DANFE := TACBrNFeDANFEFR.Create(nil);
    carregaConfiguracoes;
  except on E:exception do
    MessageDlg(e.Message, mtWarning, [mbOK], 0);
  end;
end;

procedure TfrmMain.importaXML;
begin
    Nfe.NotasFiscais.Clear;
    if not NFe.NotasFiscais.LoadFromFile(aFileName, false) then
      Exit;

    DataEmissao           := NFe.NotasFiscais.Items[0].NFe.Ide.dEmi;
    iNumeroNFe            := NFe.NotasFiscais.Items[0].NFe.Ide.nNF;
    sSerieNFe             := IntToStr(NFe.NotasFiscais.Items[0].NFe.Ide.serie);
    sChaveAcesso          := copy(NFe.NotasFiscais.Items[0].NFe.infNFe.ID, 4, 44);
    ValorTotal            := NFe.NotasFiscais.Items[0].NFe.Total.ICMSTot.vNF;
    sEmitente             := NFe.NotasFiscais.Items[0].NFe.Emit.xNome;
    sDestinatario         := NFe.NotasFiscais.Items[0].NFe.Dest.CNPJCPF;
    sArquivoXML           := NFe.NotasFiscais.Items[0].XML;

end;

procedure TfrmMain.Panel5Click(Sender: TObject);
var
 sXML, NomeArquivo: string;
begin
  if sArquivoXML <> '' then
  begin
  if rbPaisagem.checked then
      DANFE.FastFile := IncludeTrailingPathDelimiter(ExtractFilePath(ParamStr(0))) + 'DANFePaisagem.fr3';
    if rbRetrato.Checked then
      DANFE.FastFile := IncludeTrailingPathDelimiter(ExtractFilePath(ParamStr(0))) + 'DANFeRetrato.fr3';
    sXML := sArquivoXML;
    NFe.NotasFiscais.LoadFromString(sXML);
    NFe.NotasFiscais.Imprimir;
  end
  else
    MessageDlg('É necessário importar um arquivo XML para gerar o DANFe.', mtInformation, [mbOK], 0);
end;

procedure TfrmMain.Panel6Click(Sender: TObject);
begin
  if Dados.OpenDialog.Execute then
    ImportaXML(Dados.OpenDialog.FileName);
end;

end.
